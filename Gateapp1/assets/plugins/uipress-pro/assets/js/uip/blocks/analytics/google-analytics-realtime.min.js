const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;import*as connectGoogle from"./google-connect-account.min.js";export function moduleData(){return{components:{"uip-connect-google":connectGoogle.moduleData()},props:{display:String,name:String,block:Object,contextualData:Object},data:function(){return{loading:!0,error:!1,apiLoaded:!1,errorMessage:"",total:0,firstRun:!1,comparisonTotal:0,percentChange:0,fetchingQuery:!1,showGoogleConnection:!1,requestFromGroupDate:!1,currentRequest:!1,chartData:{data:{main:[],comparison:[]},labels:{main:[],comparisons:[]},title:"",colors:{main:this.returnLineColor,comp:this.returnCompLineColor}},strings:{lastPeriod:__("last period","uipress-pro"),selectDataMetric:__("Please select a chart metric in this block's options to show chart data.","uipress-pro"),changeAccount:__("Switch account","uipress-pro"),minutesAgo:__("minutes ago","uipress-pro"),thirtyMinutesAgo:__("Thirty minutes ago","uipress-pro"),now:__("Now","uipress-pro")}}},inject:["uipData","uipress","uiTemplate"],watch:{"block.settings.block.options.chartDataType":{handler(t,e){this.currentRequest&&this.processResponse()}},"uiTemplate.googleAnalytics.ready":{handler(t,e){this.getAnalytics()},deep:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(t,e){this.refreshAnalytics()}}},mounted:function(){let t=this;this.getAnalytics(),setTimeout(function(){t.getAnalytics()},6e4)},computed:{returnTotal(){return this.total},returnComparisonTotal(){return this.comparisonTotal},returnChartData(){return this.chartData},returnName(){let t=this.uipress.get_block_option(this.block,"block","chartName",!0);return t?this.uipress.isObject(t)?"string"in t?t.string:void 0:t:""},returnChartType(){return this.uipress.get_block_option(this.block,"block","chartDataType")},returnLineColor(){return this.uipress.get_block_option(this.block,"block","chartColour")},returnCompLineColor(){return this.uipress.get_block_option(this.block,"block","chartCompColour")},hideChart(){return this.uipress.get_block_option(this.block,"block","hideChart")},inlineAccountSwitch(){return this.uipress.get_block_option(this.block,"block","inlineAccountSwitch")},returnClasses(){let t="";return t+=this.uipress.get_block_option(this.block,"advanced","classes")},hasGlobalDate(){return void 0!==this.contextualData&&(!!this.uipress.isObject(this.contextualData)&&("groupDate"in this.contextualData&&("start"in this.contextualData.groupDate&&"end"in this.contextualData.groupDate)))}},methods:{getAnalytics(){let t,e,i=this;if(i.loading=!0,i.error=!1,i.errorMessage="",i.showGoogleConnection=!1,!i.uipress.isObject(i.uiTemplate.googleAnalytics))return void(i.apiLoaded=!1);if(!("ready"in i.uiTemplate.googleAnalytics))return void(i.apiLoaded=!1);if(!i.uiTemplate.googleAnalytics.ready)return void(i.apiLoaded=!1);i.apiLoaded=!0;let r=14;i.firstRun&&(r=12*Math.random()+2),i.firstRun=!0,(e=new Date).setDate(e.getDate()-1),(t=new Date).setDate(t.getDate()-r),i.uiTemplate.googleAnalytics.api("get",t,e).then(t=>{if(t.error)return i.loading=!1,i.error=!0,i.errorMessage=t.message,void("no_account"==t.type&&(i.showGoogleConnection=!0));i.loading=!1,i.currentRequest=t,i.processResponse(t)})},processResponse(){let t=this,e=this.currentRequest,i=(e.timeline.report.dates,e.timeline.report_comparison.dates,t.returnChartType),r=e.active_now.report,o=[],s=[];for(let e=0;e<=29;e+=1){o.push(e+" "+t.strings.minutesAgo);let a=e;a<10&&(a="01");let n=r.data.find(t=>t.minutesAgo==a);n?s.push(n[i]):s.push(0)}s.reverse(),o.reverse(),t.total=r.totals[i],t.chartData.colors.main=t.returnLineColor,t.chartData.title=t.returnName,t.chartData.type="bar",t.chartData.data.main=s,t.chartData.labels.main=o},removeAnalyticsAccount(){let t=this;t.uiTemplate.googleAnalytics.ready=!1,t.uiTemplate.googleAnalytics.api("removeAccount").then(e=>{t.uiTemplate.googleAnalytics.api("refresh").then(e=>{t.uiTemplate.googleAnalytics.ready=!0,t.getAnalytics()})})},secondsToTime(t){if(isNaN(t))return 0;Math.floor(t/3600).toString().padStart(2,"0");const e=Math.floor(t%3600/60).toString().padStart(2,"0"),i=Math.floor(t%60).toString().padStart(2,"0");return 0==e?"0m "+i+"s":e+"m "+i+"s"},refreshAnalytics(){let t=this;t.uiTemplate.googleAnalytics.ready=!1,t.uiTemplate.googleAnalytics.api("refresh").then(e=>{e&&(t.uiTemplate.googleAnalytics.ready=!0,t.getAnalytics())})},returnErrrorMessage(){try{JSON.parse(this.errorMessage)}catch(t){return this.errorMessage}if(this.uipress.isObject(JSON.parse(this.errorMessage))){let t=JSON.parse(this.errorMessage);return`\n              <h5 style="margin:0">${t.status}</h5>\n              <p style="margin-bottom:0;">${t.message}</p>\n            `}return this.errorMessage}},template:'\n\t\t  <div class="uip-flex uip-flex-column" :id="block.uid" :class="returnClasses">\n      <div class="uip-flex uip-flex-between">\n        <div class="uip-margin-bottom-xxs uip-text-normal uip-chart-title">{{returnName}}</div>\n        <drop-down dropPos="left" v-if="!inlineAccountSwitch && !showGoogleConnection">\n          <template v-slot:trigger>\n            <div class="uip-icon uip-link-muted uip-text-l">more_horiz</div>\n          </template>\n          <template v-slot:content>\n            <div class="uip-flex uip-flex-row uip-gap-xxs uip-flex-center uip-padding-xxxs uip-link-muted" @click="removeAnalyticsAccount()">\n              <div class="uip-icon">sync</div>              <div class="uip-padding-xxs">{{strings.changeAccount}}</div>\n            </div>\n          </template>\n        </drop-down>  \n      </div>\n      <div class="uip-margin-bottom-xxs"><uip-connect-google v-if="showGoogleConnection" :success="refreshAnalytics"></uip-connect-google></div>\n      <div v-if="loading" class="uip-padding-m uip-flex uip-flex-center uip-flex-middle uip-min-w-200 uip-w-100p uip-ratio-16-10 uip-border-box"><loading-chart></loading-chart></div>\n      <div v-else-if="error && errorMessage" class="uip-padding-xs uip-border-round uip-background-orange-wash uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-100p" v-html="returnErrrorMessage()"></div>\n      <div v-else-if="!returnChartType" class="uip-padding-xxs uip-border-round uip-background-green-wash uip-text-green uip-text-bold uip-margin-bottom-s uip-scale-in-top uip-max-w-200">{{strings.selectDataMetric}}</div>\n      <div v-else class="uip-min-w-200">\n        <div class="uip-flex uip-flex-column uip-row-gap-xs">\n          <div class="uip-flex uip-flex-between uip-gap-xxs uip-flex-center uip-margin-bottom-xs">\n            <div class="uip-text-xl uip-text-bold">{{returnTotal}}</div>\n            \n            <div class="uip-text-s uip-background-orange-wash uip-border-round uip-padding-xxxs uip-padding-left-xs uip-padding-right-xs uip-post-type-label uip-flex uip-gap-xxs uip-flex-center uip-text-bold uip-tag-label">\n              live\n            </div>\n            \n          </div>\n          <uip-chart v-if="!hideChart" :chartData="returnChartData"></uip-chart>\n          <div class="uip-flex uip-flex-row uip-flex-between" v-if="!hideChart">\n            <div class="uip-text-s uip-text-muted uip-chart-label">{{strings.thirtyMinutesAgo}}</div>\n            <div class="uip-text-s uip-text-muted uip-chart-label">{{strings.now}}</div>\n          </div>\n        </div>\n      </div>\n\t\t </div>'}};