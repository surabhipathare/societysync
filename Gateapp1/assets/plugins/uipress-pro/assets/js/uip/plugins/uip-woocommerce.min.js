const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;export function moduleData(){return{props:{},data:function(){return{ready:!1,hasLicence:!1,noWC:!1,queryURL:!1,reportRunning:!1,token:!1,saveAccountToUser:!1,cache:{},queue:[],dev:!1}},inject:["uipData","uipress","uiTemplate"],watch:{ready:{handler(e,t){this.uiTemplate.wooComnmerce.ready=this.returnStatus},deep:!0}},mounted:function(){this.createQueue(),this.startSetup(),this.pushToGlobal()},computed:{returnStatus(){return this.ready}},methods:{createQueue(){this.queue=((e,t)=>{const r=[],a=()=>{r[0]&&r[0]().then(function(e){return e}).catch(t).then(()=>r.shift()).then(a).then()};return async e=>{if(r.push(e),1===r.length)return new Promise((e,t)=>{a()})}})()},pushToGlobal(){this.uiTemplate.wooComnmerce={},this.uiTemplate.wooComnmerce.api=this.uipWCAnalytics,this.uiTemplate.wooComnmerce.ready=this.returnStatus},async uipWCAnalytics(e,t,r){let a=this;if(!a.hasLicence){let e={error:!0};return e.message=__("No pro licence found. Please add a valid pro licence to use woocommerce analytics","uipress-pro"),e.type="no_licence",e}if(!a.noWC){let e={error:!0};return e.message=__("Woocommerce needs to be active on this site to use woocommerce analytics blocks","uipress-pro"),e.type="no_woocommerce",e}if("get"==e){const e=a.getDates(t,r),n=(e,t)=>new Promise((r,n)=>a.runReport(e,r,t));return await new Promise((t,r)=>{this.queue(()=>n(e,t))})}},startSetup(){this.getQueryURL()},async getQueryURL(e){let t=this;t.cache={},t.hasLicence=!1,t.noWC=!1,t.ready=!1,t.queryURL=!1;let r=new FormData;return r.append("action","uip_build_woocommerce_analytics_query"),r.append("security",uip_ajax.security),await t.uipress.callServer(uip_ajax.ajax_url,r).then(r=>(t.ready=!0,r.error?("no_licence"==r.error_type&&(t.noWC=!0,t.hasLicence=!1),"no_woocommerce"==r.error_type&&(t.hasLicence=!0,t.noWC=!1),void 0!==e&&e(!1),!1):(t.hasLicence=!0,t.noWC=!0,t.queryURL=r.url,void 0!==e&&e(!0),!0)))},async runReport(e,t,r){let a=this,n=`&sd=${e.startDate}&ed=${e.endDate}&sdc=${e.startDateCom}&edc=${e.endDateCom}`;a.queryURL;if(a.cache[e.startDate+e.endDate])return t(!0),void r(a.cache[e.startDate+e.endDate]);console.log("report running"),a.reportRunning=!0;let o=new FormData;o.append("action","uip_run_woocommerce_analytics_query"),o.append("security",uip_ajax.security),o.append("dates",JSON.stringify(e)),a.uipress.callServer(uip_ajax.ajax_url,o).then(n=>{if(a.reportRunning=!1,n.error){let e=n.message,o=__("Unable to fetch analytic data","uipress-pro");a.uipress.notify(o,e,"error",!0,!1),t(!0),r(n)}a.cache[e.startDate+e.endDate]=n,t(!0),r(n)})},getDates(e,t){let r=this.daysDifference(e,t),a={};return a.startDate=this.returnFormattedDate(e),a.endDate=this.returnFormattedDate(t),e.setDate(e.getDate()-1),a.endDateCom=this.returnFormattedDate(e),e.setDate(e.getDate()-r+1),a.startDateCom=this.returnFormattedDate(e),a},returnFormattedDate(e){let t=e.getMonth()+1,r=e.getDate(),a=e.getFullYear();return t<10&&(t="0"+t),r<10&&(r="0"+r),a+"-"+t+"-"+r},daysDifference(e,t){let r=t.getTime()-e.getTime();return Math.round(r/864e5)+1}},template:" "}};