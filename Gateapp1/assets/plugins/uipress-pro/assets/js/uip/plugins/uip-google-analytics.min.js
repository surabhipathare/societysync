const{__:__,_x:_x,_n:_n,_nx:_nx}=wp.i18n;export function moduleData(){return{props:{},data:function(){return{ready:!1,hasAccount:!1,hasLicence:!1,queryURL:!1,reportRunning:!1,token:!1,saveAccountToUser:!1,cache:{},queue:[],dev:!1}},inject:["uipData","uipress","uiTemplate"],watch:{ready:{handler(e,t){this.uiTemplate.googleAnalytics.ready=this.returnStatus},deep:!0},"uiTemplate.globalSettings.options.analytics.saveAccountToUser":{handler(e,t){this.startSetup()}}},mounted:function(){this.createQueue(),this.startSetup(),this.pushToGlobal()},computed:{returnStatus(){return this.ready},returnAccountOnUser(){return void 0!==this.uiTemplate.globalSettings.options&&("analytics"in this.uiTemplate.globalSettings.options&&"saveAccountToUser"in this.uiTemplate.globalSettings.options.analytics&&this.uiTemplate.globalSettings.options.analytics.saveAccountToUser)}},methods:{createQueue(){this.queue=((e,t)=>{const a=[],r=()=>{a[0]&&a[0]().then(function(e){return e}).catch(t).then(()=>a.shift()).then(r).then()};return async e=>{if(a.push(e),1===a.length)return new Promise((e,t)=>{r()})}})()},pushToGlobal(){this.uiTemplate.googleAnalytics={},this.uiTemplate.googleAnalytics.api=this.uipAnalytics,this.uiTemplate.googleAnalytics.ready=this.returnStatus},async uipAnalytics(e,t,a){let r=this;if("refresh"==e)return await new Promise((e,t)=>{r.getQueryURL(e)});if(!r.hasAccount){let e={error:!0};return e.message=__("No google account connected","uipress-pro"),e.type="no_account",e}if(!r.hasLicence){let e={error:!0};return e.message=__("No pro licence found. Please add a valid pro licence to use google analytics","uipress-pro"),e.type="no_licence",e}if("get"==e){const e=r.getDates(t,a),n=(e,t)=>new Promise((a,n)=>r.runReport(e,a,t));return await new Promise((t,a)=>{this.queue(()=>n(e,t))})}return"removeAccount"==e?await new Promise((e,t)=>{r.removeAnalyticsAccount(e)}):void 0},startSetup(){this.getQueryURL()},async getQueryURL(e){let t=this;t.cache={},t.saveAccountToUser=this.returnAccountOnUser,t.hasAccount=!1,t.hasLicence=!1,t.ready=!1,t.queryURL=!1;let a=new FormData;return a.append("action","uip_build_google_analytics_query"),a.append("security",uip_ajax.security),a.append("saveAccountToUser",t.saveAccountToUser),await t.uipress.callServer(uip_ajax.ajax_url,a).then(a=>(t.ready=!0,a.error?("no_google"==a.error_type&&(t.hasAccount=!1),"no_licence"==a.error_type&&(t.hasLicence=!1),void 0!==e&&e(!1),!1):(t.hasAccount=!0,t.hasLicence=!0,t.queryURL=a.url,void 0!==e&&e(!0),!0)))},async runReport(e,t,a){let r=this,n=`&sd=${e.startDate}&ed=${e.endDate}&sdc=${e.startDateCom}&edc=${e.endDateCom}`,s=r.queryURL+n;if(r.cache[e.startDate+e.endDate])return t(!0),void a(r.cache[e.startDate+e.endDate]);r.reportRunning=!0;let o=new FormData;r.uipress.callServer(s,o).then(n=>{if(r.reportRunning=!1,n.error){let e=n.message,s=__("Unable to fetch analytic data");r.uipress.notify(s,e,"error",!0,!1),t(!0),a(n)}n.access_token&&this.saveToken(n.access_token),r.cache[e.startDate+e.endDate]=n,t(!0),a(n)})},saveToken(e){let t=this;if(!e||""===e)return;if(e==t.token)return;let a=new FormData;a.append("action","uip_save_access_token"),a.append("security",uip_ajax.security),a.append("token",e),t.uipress.callServer(uip_ajax.ajax_url,a).then(a=>{a.error?t.uipress.notify(a.message,"","error",!0,!1):t.token=e})},getDates(e,t){let a=this.daysDifference(e,t),r={};return r.startDate=this.returnFormattedDate(e),r.endDate=this.returnFormattedDate(t),e.setDate(e.getDate()-1),r.endDateCom=this.returnFormattedDate(e),e.setDate(e.getDate()-a),r.startDateCom=this.returnFormattedDate(e),r},returnFormattedDate(e){let t=e.getMonth()+1,a=e.getDate(),r=e.getFullYear();return t<10&&(t="0"+t),a<10&&(a="0"+a),r+"-"+t+"-"+a},daysDifference(e,t){let a=t.getTime()-e.getTime();return Math.round(a/864e5)+1},async removeAnalyticsAccount(e){let t=this,a=new FormData;a.append("action","uip_remove_analytics_account"),a.append("security",uip_ajax.security),a.append("saveAccountToUser",t.saveAccountToUser),t.uipress.callServer(uip_ajax.ajax_url,a).then(a=>a.error?(t.uipress.notify(a.message,"","error",!0,!1),void e(!1)):(t.getQueryURL(),void e(!0)))}},template:" "}};